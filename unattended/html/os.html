<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Unattended Windows Installation:  The OS</title>
</head>
<body>

<p>This document is part of <a
href="http://unattended.sourceforge.net/"
>http://unattended.sourceforge.net/</a>.

<hr>
<h1>Overview</h1>

To perform an unattended installation of Windows NT, 2000, or XP, you
need to:

<ol>
<li><a href="#install-share">Create the OS distribution point</a>
(basically, a folder holding a copy of the Windows CD-ROM)

<li><a href="#bootdisk">Create the DOS network boot disk</a>

<li><a href="#go">Boot from it</a>, answer a bunch of questions, and
go get a snack while the OS installs itself

</ol>

<h1 id="install-share">Create the OS distribution point</h1>

<p>In principle, the OS distribution point could be a CD-ROM or a
local disk directory, but we are going to use a network share.

<h2>Create the \\ntinstall\install share</h2>
<p>Copy the <code>install</code> directory tree from this project's
distribution to a Windows file server (say, a Unix box running <a
href="http://www.samba.org/">Samba</a>), and export it read-only with
guest access permitted.  The sample scripts, and this documentation,
assume that this share is called <code>\\ntinstall\install</code>.  In
other words, the name <code>ntinstall</code> is an alias for the file
server and the share is named <code>install</code>.  If you want to
use different names, that is OK, but you will need to modify the
scripts to refer to it (just search for "ntinstall").

<p>This procedure relies on the following files and directories from
the <code>install</code> share:

<dl>

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/djgpp/"
>djgpp</a>

<dd>Contains parts of <a
href="http://www.delorie.com/djgpp/">DJGPP</a>, a collection of Unix
tools for DOS.  This one is too big to bundle, so you will need to
download it yourself; <a href="#djgpp">see below</a> for instructions.
(Is it really worth it just so we can write a Bourne shell script
instead of a <code>.bat</code> file?  Yes, it is.)

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/dosbin/"
>dosbin</a>

<dd>Directory containing DOS utility programs (like fdisk) from the <a
href="http://www.freedos.org/">FreeDOS</a> project.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/install.sh?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>install.sh</a>

<dd>Shell script run by <code>autoexec.bat</code> on the bootdisk.
This is the first entry point to the networked portion of the
installation.  This script will ask you a bunch of questions, then
start the actual unattended installation.  You may need to edit this
script slightly for your site.

<dt><a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/unattend.txt?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup" >unattend.txt</a>

<dd>Prototype <code>unattend.txt</code>.  The <code>install.sh</code>
script will copy this to your local drive and offer to let you edit
it.  <a href="#answer-file">See below</a> for more information.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/win2k/"
>win2k</a>

<dd>Directory holding a copy of the <code>i386</code> folder from a
Windows 2000 CD-ROM.  You will need to populate this if you want to
install Win2k (as <a href="http:cd-rom">described below</a>).

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/win2ksp3/"
>win2ksp3</a>

<dd>Just like <code>win2k</code>, but with Service Pack 3 already
integrated (also <a href="http:service-pack">described below</a>).

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/winxp/"
>winxp</a>

<dd>Similarly, but for Windows XP.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/winxpsp1/"
>winxpsp1</a>

<dd>Similarly, but for Windows XP with integrated Service Pack 1.

</dl>

<h2 id="djgpp">Download DJGPP</h2>

<p><a href="http://www.delorie.com/djgpp/">DJGPP</a> is a port of the
Unix environment to DOS.  You will need to download the following
components:

<ul>
<li>The basic development kit (<a
href="ftp://ftp.simtel.net/pub/simtelnet/gnu/djgpp/v2/djdev203.zip"
>v2/djdev203.zip</a>)

<li>The DPMI server (<a
href="ftp://ftp.simtel.net/pub/simtelnet/gnu/djgpp/v2misc/csdpmi5b.zip"
>v2misc/csdpmi5b.zip</a>)

<li>The Bash port (<a
href="ftp://ftp.simtel.net/pub/simtelnet/gnu/djgpp/v2gnu/bsh204b.zip"
>v2gnu/bsh204b.zip</a>)

</ul>

<p>Just unzip all of them under
<code>\\ntinstall\install\djgpp</code>.

<h2 id="cd-rom">Copy the Windows CD-ROM to the share</h2>
<p>Copy the <code>i386</code> folder from the Windows CD-ROM to the
appropriate subdirectory of the <code>install</code> share.  For
example, for Windows 2000 Service Pack 3, copy the <code>i386</code>
folder to <code>\\ntinstall\install\win2ksp3</code>.

<h3 id="service-pack">Integrate the service pack (optional)</h3>

<p>This step is optional; you can apply a service pack just like you
apply any other hotfix later.  But combining the service pack into the
distribution point now will make installation faster.

<p>To apply the service pack to the installation point, use the
"slipstreaming" feature introduced in Windows 2000 Service Pack 1
(i.e., not supported by NT).  You can find details in Microsoft's <a
href="http://www.microsoft.com/windows2000/downloads/servicepacks/sp3/spdeploy.htm"
>Installation and Deployment Guide for Win2k SP3</a>, but the process
is pretty simple.  Using Win2k SP3 as an example:

<ol>

<li>Download <a
href="http://www.microsoft.com/windows2000/downloads/servicepacks/sp3/"
>the service pack (<code>w2ksp3.exe</code>)</a> from Microsoft.

<li>Run
<pre>
    w2ksp3.exe /u /x:c:\sp3
</pre>
<p>This extracts the service pack files to <code>c:\sp3</code>.

<li>Run
<pre>
    c:\sp3\i386\update\update.exe /s:\\ntinstall\install\win2ksp3
</pre>

<p>This applies the service pack to the distribution point
<code>\\ntinstall\install\win2ksp3</code>, creating an integrated
("slipstreamed") Win2k SP3 tree.  Due to a bug, you must be a local
administrator for this command to work, even if you have write access
to the target folder.

</ol>

<h3 id="drivers">Add device drivers</h3>

<p>This step may be optional, depending on your hardware and which
version of Windows you are trying to install.  Each release of Windows
generally ships with a fairly large collection of drivers, supporting
most of the hardware which was current at the time.  However, if you
are installing, say, Windows 2000 on a recent system (especially a
laptop), you may find that it does not support some or all of your
hardware.

<p>You can add the device drivers later, of course.  But if you want
to automate both OS and application installation, you will need to
provide at least the proper network drivers on the OS distribution
point.  Here is how to do it.

<p>First, download the driver package from the hardware vendor and
expand it.  There should be a collection of <code>.inf</code> files in
the top-level directory or possibly a subdirectory; that is the
directory you need to copy to the OS distribution share.

<p>To where should you copy it?  That is a long story...

<p>Under the <code>i386</code> folder, create a folder named
<code>$oem$</code>.  Under <b>that</b> folder, create a folder named
<code>$1</code>.  (Yes, really.)  Windows Setup will copy everything
below the <code>$1</code> folder to the <code>C:</code> drive during
installation.

<p>You may put the driver folder anywhere you like under the
<code>$1</code> directory, as long as you add it to
<code>OemPnPDriversPath</code> in the <code>unattend.txt</code> file.
(<a href="#answer-file">See below</a> for more informatoin on
<code>unattend.txt</code>.)

<p>For example, at my site we have a folder named
<code>//ntinstall/install/win2ksp3/i386/$oem$/$1/drivers/net/IntelPRO</code>
which holds the Intel Pro/100 network family drivers, and we have a
folder named
<code>//ntinstall/install/win2ksp3/i386/$oem$/$1/drivers/video/T22</code>
which holds the video drivers for the IBM ThinkPad T22 laptop.  Both
of these paths, starting with <code>drivers/</code> level, appear in
<code>OemPnPDriversPath</code> in our <code>unattend.txt</code> file.

<h1 id="bootdisk">Create the DOS network boot disk</h1>

<p>The goal here is very simple: To boot to DOS so we can mount
<code>\\ntinstall\install</code> as the <code>Z:</code> drive and run
the <code>install.sh</code> script.

<h2>Prerequisites</h2>

<p>To create the floppy disk images, you will need the <a
href="http://mtools.linux.lu/">Mtools</a> suite installed on your Unix
box.  You probably already have them; type <kbd>mcopy</kbd> to find
out.

<p>(Oh, did I mention you actually <b>need</b> a Unix box?  The
bootdisk is the only part of this project which requires one.  If you
are a Windows wizard interested in making this procedure work using
Windows only, <a href="mailto:patl@users.sourceforge.net">contact
me</a> and we can collaborate.  It should not be very difficult.)

<p>To create the ISO image (optional), you will need the <a
href="http://www.andante.org/mkisofs.html">mkisofs</a> utility.

<p>For the ISO image and the tftpboot directory (both optional), you
will need parts of the <a href="http://syslinux.zytor.com/"
>SYSLINUX</a> package.  But the parts you need are small (one of the
beauties of SYSLINUX), so I have included them in the distribution.

<h2>Booting from floppy</h2>

<p>The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/bootdisk/"
>bootdisk</a> directory from this project will help you create a
bootable DOS disk with network access.  Simply
<kbd>cd&nbsp;bootdisk</kbd> and run <kbd>make&nbsp;images</kbd> to
generate a bunch of floppy disk images in the <code>images</code>
subdirectory.

<p>You will find one floppy disk image for each supported network
driver, named after the NDIS driver for that card.  The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/bootdisk/DRIVERS.txt?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>DRIVERS.txt</a> file describes the supported drivers.

<p>You will need to use the floppy image with the right driver for
your network card.  If you are not sure which driver is right, you may
need to try them all (but see below about <a href="#netboot">booting
directly from the network</a>).

<p>The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/bootdisk/template"
>template</a> subdirectory contains the files on the boot disk itself.
For example, if you want to change <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/bootdisk/template/autoexec.bat?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>autoexec.bat</a> or <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/bootdisk/template/config.sys?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>config.sys</a>, just edit them there and run
<kbd>make&nbsp;images</kbd> again.  (Most of the binaries on the
bootdisk are just Microsoft's <a
href="ftp://ftp.microsoft.com/bussys/clients/msclient/" >MSCLIENT</a>
distribution.  The one exception is <code>random.com</code>, a very
handy utility from <a
href="http://home.mnet-online.de/horst.muc/horst.htm">Horst
Schaeffer's collection</a>.)

<p>Once you have picked the correct floppy image for your network
card, you will need to write it to a floppy.  How you do this depends
on your operating system; on Linux, something like
<pre>
    dd&nbsp;if=images/e100b.img&nbsp;of=/dev/fd0
</pre>

<p>...will do the trick.

<h2>Booting from CD-ROM</h2>

<p>This section is optional; you can kick off the installation process
just using a floppy.  But a CD-ROM is faster, and it can hold
<b>all</b> of the floppy images at once.

<p>To boot from a CD-ROM, we will use the <a
href="http://syslinux.zytor.com/iso.php">ISOLINUX</a> and <a
href="http://syslinux.zytor.com/memdisk.php">memdisk</a> utilities
from the excellent <a href="http://syslinux.zytor.com/">SYSLINUX</a>
package.  (Do not be fooled by the name; SYSLINUX is a very powerful
boot loader whose use goes far beyond Linux.  It is perfect for this
application, for example.)  These tools are included in the
distribution.  From the <code>bootdisk</code> directory, just type
<kbd>make iso</kbd>.  You should end up with a
<code>bootdisk.iso</code> image, suitable for burning to a CD-ROM.
Booting this CD-ROM will give you a choice of "virtual floppies" to
boot; choose the one with the right driver for your network card.

<h2 id="netboot">Booting from the network</h2>

<p>This section is also optional, although "nothing but net" installs
really are the most fun.

<p>Most modern network cards support booting directly from the network
following Intel's <em>Preboot eXecution Environment</em> (PXE)
specification.  You can download the PXE specification from <a
href="http://www.intel.com/labs/manage/wfm/wfmspecs.htm">Intel's WFM
site</a>, but the basic idea is simple: Just configure your DHCP
server to provide "filename" and "next-server" DHCP options naming the
file and TFTP server for the PXE boot loader.

<p>Which boot loader?  We will use <a
href="http://syslinux.zytor.com/pxe.php">PXELINUX</a>, also from the
SYSLINUX package.  This works just like booting from CD-ROM, using
<code>memdisk</code> to load a virtual floppy, but now you do not need
to select a network driver (!).  3com has kindly written a "universal"
DOS network driver which runs over any PXE implementation, allowing
one floppy image to support any PXE-compatible network hardware.

<p>NOTE: Historically (meaning as recently as 2002), most vendors' PXE
implementations have been extremely buggy.  Always flash the firmware
on your network card to the latest version before attempting a network
boot.  For network hardware embedded on a motherboard or laptop, this
probably means flashing the system BIOS.

<p>In the <code>bootdisk</code> directory, type
<kbd>make&nbsp;tftpboot</kbd>.  This will populate the tftpboot
directory with everything you need; just copy it to /tftpboot on your
TFTP server, set up your DHCP server as described above, and you
should be good to go.

<p>Actually getting your machine to boot from the network can take
some work.  Most network cards have a BIOS of their own which you can
access, in which you can enable the PXE support.  For on-board network
hardware, the system BIOS may have a configuration option called
"Enable on-board network" with <b>three</b> settings: "On", "Off", and
"On w/ PXE".

<p><b>After</b> you have enabled PXE support in the network card BIOS,
reboot the machine, enter the system BIOS, and examine the "boot
order" option.  There should be a new entry, with a name like "MBA
slot 0" or "IBA slot 0".  (Note that many BIOSes have a "Network"
option here which is <b>not</b> what you want.  I am not even sure
what it does; it may be some token-ring thing.)

<p>Some systems (e.g., Dell PowerEdge and Optiplex series) will
respond to "F12" during power-up to initiate a network boot.  This is
convenient, because we only want to boot from the network to kick off
the OS installation; we want future boots to be from the hard drive.

<p>If all else fails, contact your vendor and ask them how to perform
a PXE network boot.  If they say you cannot, stick your tongue at them
and use a floppy or CD-ROM instead.

<h1 id="go">Use the boot disk</h1>

<p>The bootdisk's entire purpose in life is to obtain access to the
network, then hand off control to the more powerful tools available
there.  In particular, the bootdisk mounts
<code>\\ntinstall\install</code> as the <code>Z:</code> drive, then
executes the Bourne shell script <code>z:\install.sh</code>.  This
script will help you perform several preparatory tasks and then launch
the OS installer.

<h2>Mounting <code>Z:</code></h2>

<p>After loading the network stack, the boot disk runs
<code>net&nbsp;use&nbsp;Z:&nbsp;\\ntinstall\install</code>.  This will
prompt you for a user name, password, and whether you want to save the
password in your "password list".  (Since ramdisks are volatile, this
last option is useless, but I have been unable to figure out how to
suppress it.)  If your <code>\\ntinstall\install</code> share is
exported with "guest" access allowed, you can simply press
<kbd>Enter</kbd> three times here.

<p>If the share does not allow guest access, you may provide any valid
user name and password to map the share.  You will then be able to
install the operating system, but you may have problems when the
process moves on to installing the applications, because that requires
mapping the <code>Z:</code> drive from Windows.  All in all, you are
probably best off permitting (read-only) guest access to the
<code>install</code> share.

<h2>Partitioning and formatting</h2>

<p>The <code>install.sh</code> script begins by helping you partition
and format the drive.

<p>The partition table must have a small (< 2G) FAT partition for the
<code>C:</code> drive.  Do not worry; Windows Setup will later expand
the partition to take up any adjacent free space, and it will convert
the partition to NTFS.

<p>The menu will offer to partition the disk automatically using a few
layouts which I like, or you can partition the disk manually.  Using
any of these options will reboot the machine to let the BIOS notice
the partition table change.

<p>Once you have a small FAT partition as the <code>C:</code> drive,
you need to format it; just select that option from the menu.

<h2>Choosing the operating system</h2>

<p>Next, <code>install.sh</code> will ask you which operating system
you want to install.  If you do not see the one you want, send me a
feature request (or add it yourself and send me a patch).

<h2>Choosing the application suite</h2>

<p>Next, <code>install.sh</code> will ask you which script to run (if
any) when the OS installation is finished.  This is the hook by which
the application installation process is initiated.  The scripts are
found in the <code>scripts</code> directory under the install share,
which is discussed in the <a href="apps.html">application
installation</a> portion of this documentation.

<p><code>install.sh</code> will use this information to create
<code>C:\netinst\toplev.bat</code>, which is listed in the
<code>unattend.txt</code> file as the script to run when OS
installation is finished.

<h2 id="answer-file">Editing unattend.txt</h2>

<p>Finally, <code>install.sh</code> will copy the sample <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/unattend.txt?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
><code>z:\unattend.txt</code></a> file to the <code>c:\netinst</code>
directory and offer to let you edit it.

<p>The <code>unattend.txt</code> file, also known as the "answer
file", is the key to this whole process.  Normally, <em>Windows
Setup</em> tosses up lots of dialogs to ask you questions like, "What
is your name?", "What is your license key?", and so on.  By passing
the right flags to the installer (<code>i386\winnt.exe</code>), we
will cause <em>Windows Setup</em> to consult this file for the answers
instead.

<a name="guide"></a>
<p>The best documentation for the answer file is Microsoft's own
<em>Microsoft Windows 2000 Guide to Unattended Setup</em>.  I
recommend having this document handy as a reference.  Unfortunately,
as far as I know, you cannot download it directly; you must first
download and install the <a
href="http://www.microsoft.com/windows2000/downloads/servicepacks/sp3/supporttools.asp"
>Windows 2000 SP3 Support Tools</a>, then use Internet Explorer to
extract the <code>unattend.doc</code> file from the
<code>deploy.cab</code> archive.  You can also find
<code>deploy.cab</code> on any Windows CD in the
<code>support\tools</code> folder.

<p>Once you understand it, editing <code>unattend.txt</code> is pretty
easy.  And you certainly will want to edit it, because the template is
not going to have the correct organization name, domain, or (heh)
license key.

<p>Most lines are simple <em>key = value</em> pairs.  Lines starting
with ; are comments.  If you fail to comment out a required key, like
<em>ProductID</em>, the installation will stop at some point to throw
up a dialog asking for your license key.

<p>The keys you will most likely want to edit include:

<dl>
<dt><em>FullName</em>
<dd>The full name of the user of this computer.  The actual value is
not very important.

<dt><em>OrgName</em>
<dd>Similarly.

<dt><em>ComputerName</em>
<dd>The name of the computer.  A value of "*" tells the installer to
pick a random name.

<dt><em>ProductID</em>
<dd>Your 25-character software license key, just as it appears on your
license.

<dt><em>AdminPassword</em>
<dd>The password for the local Administrator account.

<dt><em>AutoLogon</em>

<dd>If set to "yes", Setup will patch the registry to logon
automatically as Administrator, skipping the logon screen, on every
reboot.  This setting is useful for automatically installing the
applications once the OS is done.  You can use the <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/autolog.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>autolog.pl</a> script in <code>Z:\bin</code> to enable or disable
this setting after the OS is installed.

<dt><em>JoinDomain</em>
<dd>If present, tells Setup to join this computer to a domain.

<dt><em>DomainAdmin, DomainAdminPassword</em>

<dd>These work in conjunction with <em>JoinDomain</em>.  They specify
the domain account and password to use to join the computer to the
domain.  Note that <em>DomainAdmin</em> must be in fully-specified
(<code>DOMAIN\user</code>) form.

<dt>OemPnpDriversPath

<dd>Specifies additions to the search path for Plug&amp;Play drivers.
Elements of this path are separated by semicolons.  Windows uses this
path when searching for a driver for a piece of hardware.  These paths
are relative to the <code>C:</code> drive, and are usually used in
conjunction with the <a href="#drivers"><code>$oem$/$1</code></a>
mechanism.

</dl>

<p>These are just a few important keys; for a complete list, consult
the <a href="#guide"><em>Guide to Unattended Setup</em></a>.

<p>Note that if you have standard settings for these keys at your
site, you can edit the sample <code>unattend.txt</code> file on the
<code>\\ntinstall\install</code> share so that you do not need to
retype them with every installation.


<h2>Firing it off</h2>

<p>Once you have edited <code>unattend.txt</code>, select the option
to "proceed".  This will run <code>i386\winnt.exe</code> from the OS
distribution point with the proper options to perform an unattended
installation.

<p>And that's it; your OS installation should be on its way.  You
probably want to automate <a href="apps.html">installing the
applications</a> next.

<hr>
<address>
Patrick J. LoPresti <a
href="mailto:patl@users.sourceforge.net">patl@users.sourceforge.net</a>
</address>

<A href="http://sourceforge.net/"> <IMG align="right"
src="http://sourceforge.net/sflogo.php?group_id=62053&amp;type=5"
width="210" height="62" border="0" alt="SourceForge Logo"></A>

</body>
</html>
