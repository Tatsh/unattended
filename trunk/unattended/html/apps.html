<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Unattended Windows Installation:  The Applications</title>
</head>
<body>

<p>This document is part of <a
href="http://unattended.sourceforge.net/"
>http://unattended.sourceforge.net/</a>.

<hr>
<h1>Goals</h1>

Our objective is to create a set of scripts which automatically
install all of the applications we want.  Important design goals for
these scripts include:

<ul>
<li>Independence from the OS install

<p>It should be possible (though not necessary) to install the
applications independently of the automated OS installation, because
sometimes automating the OS installation is more trouble than it is
worth.  For example, where I work, we have a large standard suite of
applications, but sometimes we are asked to set one piece of hardware
unlike any we have ever seen before.  In such cases, we just want to
install the OS by hand but still have an automated procedure for
loading the applications.

<li>Composability

<p>We should be able to define collections of software in terms of
other collections.  For instance, we should be able to express:

<blockquote>
A <em>base</em> installation consists of applications <em>A</em>,
<em>B</em>, and <em>C</em>.  A <em>developer workstation</em> consists
of a base installation plus a development environment.  A <em>sales
laptop</em> consists of a base installation plus the salesforce
automation tools.
</blockquote>

And so on.

<p>In short, these installation scripts need to be able to invoke
other installation scripts.  You might expect this to be trivial,
until you remember that installing some software requires rebooting
the machine.  So if (say) <code>sales.bat</code> begins by invoking
<code>base.bat</code>, and <code>base.bat</code> needs to reboot the
machine halfway through, how exactly do you resume where you left off?
<a href="#todo">See below</a> for my answer.

<li>Simplicity

<p>However this system works, it must be as simple to understand as
possible.  Sysadmins are busy people.  In fact, I am amazed you have
read this far :-).  Anyway, if you can think of a simpler approach for
anything here, please let me know.

</ul>

<h1>Overview</h1>

The process goes like this:
<ol>
<li>Map the <code>\\ntinstall\install</code> share as the <code>Z:</code>
drive.
<li>Install Perl.
<li>Install everything else.
</ol>

<p>Perl is required because the handy utility scripts are written in
Perl.  You do not need to know Perl to use the scripts, but you should
learn it anyway because it is a good tool.

<h2>Structure of the <code>install</code> share</h2>

<p>The <code>\\ntinstall\install</code> share is the one you created when
you set up the <a href="os.html">automated OS installation</a>,
by simply copying the <code>install</code> directory from this project's
distribution.

<p>Application installation relies on these subdirectories of the
<code>install</code> share:

<dl>

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/"
>bin</a>

<dd>Contains various utility binaries and scripts.  You should not
need to modify these; if you do, please consider submitting a patch or
feature request.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/packages/"
>packages</a>

<dd>Contains the installers for the applications themselves.  You will
need to populate this directory with the installers for your site's
applications.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/scripts/"
>scripts</a>

<dd>Contains the scripts for installing individual applications and
sets of applications.  The contents of this directory are the actual
scripts in use where I work (minus things like passwords), which
should provide a fairly rich set of examples.  You will almost
certainly need to edit these or write new ones; feel free to
contribute others.

</dl>

<h1 id="todo">The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/todo.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup">todo.pl</a>
driver script</h1>

<h2>One script to rule them all</h2>
<p>One master Perl script <code>todo.pl</code>, oversees the entire
installation process.  <b>All</b> of the other scripts are invoked by
<code>todo.pl</code>.

<p><code>todo.pl</code> maintains a "to-do list" on disk in the plain-text
file <code>C:\netinst\todo.txt</code>.  It takes any number of commands as
arguments and inserts them at the <b>front</b> of the to-do list.  (As
you will see, this is definitely what you want.)  When run as
<kbd>todo.pl&nbsp;--go</kbd>, it removes the first command from the
list and executes it, then removes the next command from the list and
executes it, and so on until the list is empty.

<p>There are multiple advantages to this design:

<ul>

<li>It provides a consistent environment (e.g., <code>PATH</code>) for
running the other scripts.

<li>It notices any errors returned by the other scripts, halting
execution so that you can debug the problem.

<li>It provides controlled reboots.

<li>It lets us satisfy the "composability" goal in a very natural way.
The to-do list is just an explicit stack; because it is stored on
disk, it naturally survives reboots.

</ul>

<h2>The <kbd>.reboot</kbd> meta-command</h2>

<p>In addition to normal commands and scripts, one other item may
appear in the to-do list: "<kbd>.reboot</kbd>".  This is a directive
to reboot the machine.  <code>todo.pl</code> knows how to reboot the
machine, first patching the registry to cause itself to run the next
time the current user logs in.

<p>In other words, <kbd>.reboot</kbd> provides a controlled mechanism
for rebooting during application installation.  This is important,
because random reboots (like those normally performed by some
installers) lead to race conditions, as the OS kills all the processes
with indeterminate ordering and timing.  When you write a script to
install an application, you must suppress any such automatic reboots
and use the <kbd>.reboot</kbd> directive instead.

<h2>The environment</h2>

<p><code>todo.pl</code> arranges to run all commands in a standard
environment, described here.

<h3><kbd>PATH</kbd></h3>

<p>The <code>PATH</code> environment variable will have
<code>Z:\bin;Z:\scripts</code> prepended to it before any commands are
run.  These means the scripts, and the to-do list, may refer to
themselves and to the utility scripts without supplying a full
pathname.

<h3 id="WINVER"><kbd>WINVER</kbd></h3>

<p>The <code>WINVER</code> environment variable will contain a short
string representing the version of windows being installed:

<dl compact>
<dt><em>win2k</em>
<dd>For Windows 2000
<dt><em>win2ksp3</em>
<dd>For Windows 2000 Service Pack 3
<dt><em>winxp</em>
<dd>For Windows XP
<dt><em>winxpsp1</em>
<dd>For Windows XP Service Pack 1
</dl>

<p>...and so on.  This variable is useful in scripts whose behavior
needs to vary between OSes; e.g., installing hotfixes.

<h1>Examples</h1>

<p>Some examples should help.  All of these are from the <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/"
>install/scripts directory</a> in the distribution.

<h2>DirectX update</h2>

<p>The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/scripts/directx81.bat?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup">directx81.bat</a>
script installs DirectX 8.1 and reboots the machine.  First, it adds
the <kbd>.reboot</kbd> directive to the to-do list.  Then it runs the
installer from the <code>Z:\packages</code> directory, taking care to wait
until the installer finishes and to supply flags to suppress the
normal reboot performed by the installer.

<p>To invoke this script manually, you would type:
<pre>
    Z:\bin\todo.pl directx81.bat
    Z:\bin\todo.pl --go
</pre>


<h2>Internet Explorer update</h2>

The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/scripts/ie6.bat?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>ie6.bat</a> script installs IE6 SP1 plus one required hotfix.  It
adds <kbd>.reboot&nbsp;q317244.bat</kbd> to the to-do list, then runs
IE6setup from under <code>Z:\packages</code> directory.  (The installer
itself is created by the <a
href="http://www.microsoft.com/windows/ieak/">Internet Explorer
Administration Kit</a>.)  The <kbd>/q</kbd> flag tells IE6setup to
work "quietly"; i.e., in unattended mode.  The <kbd>/r:n</kbd> flag
tells it to suppress the automatic reboot.

<h2>Combining updates</h2>

<p>To perform both the DirectX and IE6 updates at once, you would
type:

<pre>
    Z:\bin\todo.pl directx81.bat ie6.bat
    Z:\bin\todo.pl --go
</pre>

<p>The first line adds directx81.bat and ie6.bat to the to-do list.
The second command processes the list.  The todo.pl script will first
remove directx81.pl from the front of the to-do list (leaving just
ie6.bat) and execute it.  The directx81.bat script will push
<kbd>.reboot</kbd> onto the front of the to-do list, install DirectX,
and exit.  The todo.pl script will then remove the <kbd>.reboot</kbd>
command and execute it, arranging to restart itself after reboot.
Then it will (finally) remove ie6.bat from the to-do list and execute
it.  And so on.

<p>The end result is that DirectX 8.1, IE6 SP1, and hotfix Q317244
will all be applied, even though some of these involve rebooting the
system.

<h2>Higher-level examples</h2>

<p>The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/scripts/win2ksp3-updates.bat?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>win2ksp3-updates.bat</a> script installs all of the post-SP3 updates
to Windows 2000 Service Pack 3.  (Or at least, all of the ones we care
about where I work.)

<p>All this script does is push a bunch of items onto the to-do list,
including a bunch of hotfixes, the ie6.bat script, and the
directx81.bat script.  Several of these involve rebooting the machine.

<p>The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/scripts/base.bat?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>base.bat</a> performs a "base workstation" installation for our
organization.

<p>This example illustrates the use of the <a
href="#WINVER">WINVER</a> environment variable to choose which
"updates" script to run.  The <kbd>%WINVER%-updates.bat</kbd> entry in
the to-do list will run (for example) <kbd>win2ksp3-updates.bat</kbd>
if the operating system is Windows 2000 Service Pack 3, but it will
run <kbd>winxpsp1-updates.bat</kbd> on Windows XP Service Pack 1.

<p>This example also illustrates how to add a command with arguments
to the to-do list by putting it in quotes.  (Normally, spaces separate
the commands themselves.)  Note that since <code>todo.pl</code> always
adds items to the <b>front</b> of the to-do list, the invocations of
"startup-type.pl" will happen <b>before</b> the other items on the
to-do list.  On the other hand, <code>todo.pl</code> preserves the
order of arguments which you pass in all at once.

<p>So, for example, this command:
<pre>
    Z:\bin\todo.pl X Y
</pre>

<p>...will add X followed by Y to the to-do list.  On the other hand,
this sequence of commands:

<pre>
    Z:\bin\todo.pl X
    Z:\bin\todo.pl Y
</pre>

<p>...will add Y followed by X.  Just something to keep in mind when
reading (or writing) complicated to-do scripts.

<h2>One more example</h2>

<p>The <a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/scripts/sales.bat?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>sales.bat</a> script performs a "salesperson laptop" installation for
our organization.  As you can see, this just performs a base install,
then adds Microsoft Office, Lotus Notes, the AT&amp;T global network
dialer, and the Shiva (technically "Intel Netstructure", but I fear
change) VPN client.  Mmm, composability.

<h1>Database of unattended installer switches</h1>

<p>To create an installation script for an application, you need to
know how to install that application in "unattended" mode and without
an automatic reboot.  To help you, I am collecting a <a
href="installers.html">list of unattended/silent mode installer
switches</a> for common installers and applications.  Contributions to
this list are particularly welcome.

<h1>Other utility scripts</h1>

<p>Although <code>todo.pl</code> is the most important script, there
are others in <code>Z:\bin</code> which you might find useful:

<dl>
<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/autolog.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>autolog.pl</a>

<dd>Patches the registry to enable or disable the "automatic logon"
facility.  The <code>--disable</code> switch disables it; the
<code>--enable</code> switch enables it (and requires a username and
password as argument).

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/bootini.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>bootini.pl</a>

<dd>For some reason, whenever I use unattended installation the
machine ends up displaying a boot menu with a "Previous Operating
System on C:\" option.  This even happens if I wipe the disk with
zeroes first.  This script edits the hidden system file
<code>boot.ini</code> to get rid of the useless menu option.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/hidepw.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>hidepw.pl</a>

<dd>According to Microsoft's <em>Guide to Unattended Setup</em>,
passwords in the <code>unattend.txt</code> are overwritten when the
installation finishes.  I have not found this to be true.  So I wrote
this script to replace all passwords in <code>unattend.txt</code> with
X marks.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/instsrv.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>instsrv.pl</a>

<dd>The <a
href="http://www.microsoft.com/windows2000/techinfo/reskit/">Windows
2000 Resource Kit</a> includes a tool named <code>instsrv.exe</code>
which lets you install a service from the command line.  It is the
only tool I know of for doing this, but it requires that the password
be passed to it in the clear.  The <code>instsrv.pl</code> script
simply prompts you for a password and then invokes
<code>instsrv.exe</code>.  This does mean you need the Resource Kit to
use this script.  (Yes, strictly speaking, using this script means
your installation will no longer be "fully unattended".  But I do not
like embedding passwords in world-readable scripts, and I hate using
the GUI.)

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/notips.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>notips.pl</a>

<dd><p>As you are no doubt aware, Windows installs lots of annoying
first-time logon junk ("tips").  This script gets rid of them all at
once.  Note: This script represents my taste in things to disable; you
may want to modify it for your site.

<p>Incidentally, this script includes examples of editing the registry
settings for the <em>default user</em>; that is, the settings
inherited by every new user who logs into the machine.  Most
approaches I have seen to this involve copying some other file over
the default user's <code>NTUSER.DAT</code> file, but with Perl, you
can edit this registry hive directly.

<dt><a
href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/unattended/unattended/install/bin/startup-type.pl?rev=HEAD&amp;content-type=text/vnd.viewcvs-markup"
>startup-type.pl</a>

<dd>This script lets you set the "startup type" (<em>automatic</em>,
<em>manual</em>, or <em>disabled</em>) of a service from the
command-line.  There are probably other tools out there to do this,
but I got tired of looking for them and wrote my own.

</dl>

<hr>
<address>
Patrick J. LoPresti <a
href="mailto:patl@users.sourceforge.net">patl@users.sourceforge.net</a>
</address>

<A href="http://sourceforge.net/"> <IMG align="right"
src="http://sourceforge.net/sflogo.php?group_id=62053&amp;type=5"
width="210" height="62" border="0" alt="SourceForge Logo"></A>

</body>
</html>
