<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Unattended, A Windows deployment system: Advanced Configuration</title>
</head>
<body>

<p>This document is part of <a
href="http://unattended.sourceforge.net/">Unattended, a Windows
deployment system</a>.

<hr>

<h1>Introduction</h1>

<p>After you use Unattended a few times, you will probably get tired
of answering the same questions over and over.  This document
describes how to create site-specific configuration files to set
(or compute) the answers automatically.

<p>Unattended looks for all site-specific configuration in
<code>Z:\site</code>.  In particular, the master installation script
(<a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/dosbin/install.pl?rev=HEAD&amp;view=auto"
><code>install.pl</code></a>) reads <code>Z:\site\unattend.txt</code>
and <code>Z:\site\config.pl</code>.

<p>To perform simple customizations, just create and populate
<code>z:\site\unattend.txt</code>.  The values you put there will
override the defaults and cause the installation script to skip any
corresponding questions.  Do not worry about creating a "complete"
answer file; if you fail to provide some required value, the
installation script will prompt you for it.

<p>Read on for a description of what to put in your
<code>unattend.txt</code> file.

<p>(The <code>Z:\site\config.pl</code> mechanism is more complex and
is discussed way below.)

<h1>Syntax of <code>unattend.txt</code></h1>

<p>The general syntax of an answer file is the same as any
<code>.ini</code> (or <code>.inf</code>) file.  It looks something
like this:

<pre>
[SECTION 1]
  ; COMMENT
  KEY1=VALUE1
  KEY2
  KEY3="funny;quoted=value"

[SECTION 2]
.
.
.
</pre>

<p>That is, it consists of <em>sections</em>, each headed by a section
name in square brackets.  Each section has zero or more
<em>entries</em> (also called <em>settings</em>).  Each entry assigns
a <em>value</em> to a <em>key</em>, or else consists of a <em>key</em>
by itself.  Any line beginning with a semicolon, or whitespace
followed by a semicolon, is a <em>comment</em>.

<p>If the value contains any special characters, or if it is the empty
string, it must be placed in quotation marks.  Which characters
qualify as "special" is undocumented; the <code>.ini</code> file
parser/generator in Unattended tries to be fairly conservative, and
will exit with an error message if it encounters an unrecognized line.
Quotes are allowed even when they are not required, so when in doubt,
use them.

<p>For a complete sample <code>unattend.txt</code> file, use
Unattended to install Windows and then examine
<code>C:\NETINST\UNATTEND.TXT</code>.  For a partial file containing
some of Unattended's defaults, see <a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/lib/unattend.txt?rev=HEAD&amp;view=auto"
>Z:\lib\unattend.txt</a> from the distribution.

<h1 id="guide">Microsoft's documentation</h1>

<p>The most thorough documentation for the answer file is Microsoft's
own, but unfortunately, it is a bit annoying to obtain.  There are
different versions for Windows 2000 and Windows XP, although the
answer files are very similar.

<dl>
<dt><em>Windows 2000 Guide to Unattended Setup</em>

<dd>Microsoft put the SP1 version of this document <a
href="http://www.microsoft.com/technet/prodtechnol/windows2000pro/deploy/unattend/sp1unatd.asp"
>on the Web</a>, but they seem to have stopped with later service
packs.  The canonical way to obtain this document is to download and
install the <a
href="http://www.microsoft.com/windows2000/downloads/servicepacks/sp4/supporttools.asp"
>Windows 2000 SP4 Support Tools</a>, then use Internet Explorer to
extract the <code>unattend.doc</code> file from the
<code>deploy.cab</code> archive.

<p>You can also find an earlier version of <code>deploy.cab</code> on
the Windows 2000 CD in the <code>\support\tools</code> folder.

<dt><em>Microsoft Windows Preinstallation Reference</em>

<dd>As far as I know, this document is not available directly on the
Web.  You must first download the <a
href="http://www.microsoft.com/WindowsXP/pro/downloads/servicepacks/sp1/deploytools.asp"
>Windows XP SP1 Corporate Deployment Tools</a>,
<code>deploy.cab</code>.  Then use Internet Explorer to extract
<code>ref.chm</code>, a Windows "Compiled Help" file, which you can
double-click to browse.

<p>Here again, <code>deploy.cab</code> may also be found on the
Windows XP CD in the <code>\support\tools</code> folder.

</dl>

<p>(Personally, I find the Windows 2000 document easier to read.)

<h1>Settings used by <em>Windows&nbsp;Setup</em></h1>

<p>Here are examples for how to configure some common settings.  All
of these are used by <em>Windows&nbsp;Setup</em>, which means they are
fully explained in Microsoft's documentation.  These examples are just
to help you get started quickly.

<h2>User Name, Organization Name, and Computer Name</h2>

<p>Example:

<pre>
[UserData]
    FullName="Jane Doe"
    OrgName="FooBar Widgets, Incorporated"
    ComputerName=magneto
</pre>

<p>Setting the ComputerName to <code>*</code> tells
<em>Windows&nbsp;Setup</em> to pick a random name.

<h2>Product Key</h2>
<pre>
[UserData]
    ProductKey=XXXXX-YYYYY-ZZZZZ-00000-11111
</pre>

<p>NOTE: Prior to Windows XP, this key was named "ProductID".

<h2>Local Administrator Password</h2>

<p>To set the local Administrator account password:

<pre>
[GuiUnattended]
    AdminPassword=sekrit
</pre>

<h2>Joining a domain</h2>

<p>To join the domain <code>FOOBAR</code> using the account
<code>FOOBAR\wsadmin</code> and password <code>verysekrit</code>:

<pre>
[Identification]
    JoinDomain=FOOBAR
    DomainAdmin=FOOBAR\wsadmin
    DomainAdminPassword=verysekrit
</pre>

<p>If you do not want to store the password in cleartext, you can omit
the DomainAdminPassword entry; remember that the installation script
will prompt you for any required values which you do not already
provide.

<h2>Joining a workgroup</h2>

<p>To join the workgroup FOOBAR:

<pre>
[Identification]
    JoinWorkgroup=FOOBAR
</pre>

<p>Note that you are required to join either a domain or a workgroup.

<h2>Time Zone</h2>

<p>To set the workstation's time zone:

<pre>
[GuiUnattended]
    ; U.S. Pacific
    TimeZone=004
</pre>

<p>The time zone setting is numeric; see the <a href="timezones.html"
>table of index numbers</a> for a complete list.  The default value
for Unattended is 035 (U.S. Eastern).

<h2>OEM Plug&amp;Play Drivers</h2>

<p>You may specify additions to the search path for Plug&amp;Play
drivers.  Elements of this path are separated by semicolons.  Windows
uses this path when searching for a driver for a piece of hardware.
These elements are relative to the <code>C:</code> drive, and are
usually used in conjunction with the <a href="os.html#drivers"
><code>$oem$/$1</code></a> mechanism.

<p>For example:

<pre>
[Unattended]
    OemPnPDriversPath="drivers\net\eepro;drivers\video\nVidia"
</pre>

<h1>The [_meta] section</h1>

<p>Unattended adds some functionality on top of
<em>Windows&nbsp;Setup</em>.  This functionality is controlled by a
new section of the answer file, the <code>[_meta]</code> section.
This section is ignored by <em>Windows&nbsp;Setup</em>; it exists
solely to let you provide answers to some of the new questions <a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/dosbin/install.pl?rev=HEAD&amp;view=auto"
><code>install.pl</code></a> asks.

<h2>Partitioning and formatting</h2>

<p>The installation script begins by partitioning and formatting the
disk.

<p>To automatically answer the "Use large disk support" question, set
the <code>fdisk_lba</code> key to 1 for "yes" and 0 for "no".

<p>To automatically partition the drive, use the
<code>fdisk_cmds</code> key.  This is a semicolon-separated list of <a
href="http://usuarios.lycos.es/fenris2003/panicdsk/fdisk_HELP.TXT"
>commands</a> invoking <a
href="http://www.23cc.com/free-fdisk/">FreeDOS FDISK</a>.  Keep in
mind that the result of these commands must be a partition table with
an active 2000 megabyte FAT partition.

<p>To automatically format the drive, set the <code>format_cmd</code>
key.  This is normally an invocation of the <a
href="http://www.ibiblio.org/pub/micro/pc-stuff/freedos/files/dos/format/"
>FreeDOS format</a> utility.

<p>Finally, to automatically replace the Master Boot Record (MBR) or
not, use the <code>replace_mbr</code> key.  Set it to 1 for "yes" and
0 for "no".

<p>For example, to use large disk support, partition the drive as a
single large partition, format it, and replace the MBR:

<pre>
[_meta]
    fdisk_lba=1
    fdisk_cmds="fdisk /clear 1;fdisk /prio:2000;fdisk /activate:1"
    format_cmd="format /y /q /v: c:"
    replace_mbr=1
</pre>

<h2>Post-install script, Local Administrators, NTP servers, final edits</h2>

<p>To configure which post-installation script to run, set the
<code>top</code> key.

<p>To configure which domain accounts are added to the local
Administrators group, set the <code>local_admins</code> key to a
semicolon-separated list of user names.  An empty list is allowed, but
it must be quoted.  User names may be fully qualified (DOMAIN\user),
or they may be bare (user); in the latter case, the JoinDomain value
will be used as the domain.

<p>To configure the NTP servers, set the ntp_servers key.  This is a
space-separated list.

<p>To control the final question, where you are asked if you want to
make any final edits, use the edit_files key.  Set it to 0 to avoid
being asked the question.

<p>For example, to perform a base install, configure NTP servers named
"ntp-0" and "ntp-1", not add any accounts to the local Administrators
group, and skip the final question:

<pre>
[_meta]
    top=base.bat
    local_admins=""
    ntp_servers="ntp-0 ntp-1"
    edit_files=0
</pre>

<h2>Optional keys</h2>

<p>FIXME: need to write this...

<h1 id="perl">Programmatic configuration using config.pl</h1>

<p>If the static configuration options provided by
<code>unattend.txt</code> are not sufficient, you can create
arbitrarily complex rules using <code>Z:\site\config.pl</code>.  This
is a Perl file which <a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/dosbin/install.pl?rev=HEAD&amp;view=auto"
><code>install.pl</code></a> reads.

<p>To write your own config.pl, you need to know a little Perl and you
need to understand how the installation script works.

<h2>How the installation script works</h2>

<p>The installation script generates the answer file in memory,
placing it in an <a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/lib/Unattend/IniFile.pm?rev=HEAD&amp;view=auto"
>Unattend::IniFile</a> object named <code>$u</code>.

<p>Programmatically, this object behaves like a Perl hash (associative
array).  It maps section names to sections, where each section is
another hash which maps keys to values.  So, for example, the value
for the FullName key in the [UserData] section is just
<code>$u->{'UserData'}->{'FullName'}</code>, and you may read or
assign to this value in your config.pl.

<p>But these hashes are special in two ways.

<p>First, they are case-insensitive, so that
<code>$u->{'UserData'}->{'FullName'}</code> and
<code>$u->{'userdata'}->{'fullname'}</code> refer to the same thing.

<p>Second, if you assign a Perl subroutine to a key, something magic
happens when you read the key: The subroutine will be called with no
arguments, and the subroutine will be replaced by its own return
value.  These stored subroutines are called "promises", and the act of
evaluating the subroutine and replacing the value is called "forcing"
the promise.  (I knew that CS degree would be useful someday.)

<p>For example, suppose you wanted the local Administrator password to
be the same as the user's FullName.  This is not a very realistic
example, perhaps, but it will serve for illustration.  You would put
this in config.pl:

<pre>
$u->{'GuiUnattended'}->{'AdminPassword'} =
    sub {
        return $u->{'UserData'}->{'FullName'};
    };
</pre>

<p>This promise will not be forced until the AdminPassword key is read
(possibly not until the unattend.txt file is actually being
generated).  When that happens, the subroutine will read the value of
the FullName key in order to return it.  That, in turn, may cause
another promise to be forced, and so on...  But in the end, the
FullName will be returned by this subroutine, and it will be stored
and used as the value for AdminPassword.

<p>In fact, install.pl simply assigns a "default value" for most keys
which is a subroutine to ask the user an appropriate question.  Then
it reads unattend.txt and config.pl, each of which may override the
defaults with static values or with different subroutines.

<p>This design requires that you think in a "declarative" style rather
than an "imperative" one.  That is, you should think about how each
key is to be computed from other data (including other keys).  Except
for the top-level assignments of subroutines, you should avoid
assigning to keys themselves.

<p>Some examples should help.

<h2>Computing OemPnPDriversPath automatically</h2>

<p>To automatically add all drivers to OemPnPDriversPath, you just
crib the code from install.pl but skip the part where it asks the
question:

<pre>
use warnings;
use strict;

$u->{'Unattended'}->{'OemPnPDriversPath'} =
    sub {
        my $media_obj = Unattend::WinMedia->new ($u->{'_meta'}->{'OS_media'});
        my @pnp_driver_dirs = $media_obj->oem_pnp_dirs (1);
        # No driver directories means no drivers path
        scalar @pnp_driver_dirs > 0
            or return undef;
        print "...found some driver directories.\n";

        my $ret = join ';', @pnp_driver_dirs;
        # Setup does not like empty OemPnPDriversPath
        $ret =~ /\S/
            or undef $ret;
        return $ret;
     };
</pre>

<p>This code illustrates a couple of points.

<p>First, all Perl code you ever write should "use warnings" and "use
strict".  Do not even think twice about it.

<p>Second, if a key has a value of "undef", it will not appear in
unattend.txt at all.  If you want to delete a key completely, make it
undef.

<p>Finally, this code demonstrates the use of the <a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/lib/Unattend/WinMedia.pm?rev=HEAD&amp;view=auto"
>Unattend::WinMedia</a> helper object.  You create an instance of this
object by giving it the path to your Windows installation media
([_meta]/OS_media value).  It knows lots of things about such media,
including how to grovel it for OEM Plug&amp;Play drivers
(oem_pnp_dirs() method).

<h2>Assigning product key based on OS type</h2>

<p>To pick the product key based on OS type, you would use code like
this:

<pre>
use warnings;
use strict;

$u->{'UserData'}->{'ProductKey'} =
    sub {
        my $media_obj = Unattend::WinMedia->new ($u->{'_meta'}->{'OS_media'});
        my $os_name = $media_obj->name ();
        if ($os_name =~ /Windows XP/) {
            return 'MY-WINDOWS-XP-KEY';
        }
        elsif ($os_name =~ /Windows Server 2003/) {
            return 'MY-SERVER-2003-KEY';
        }
        return undef;
    };

$u->{'UserData'}->{'ProductID'} =
    sub {
        my $media_obj = Unattend::WinMedia->new ($u->{'_meta'}->{'OS_media'});
        my $os_name = $media_obj->name ();
        if ($os_name =~ /Windows 2000/) {
            return 'MY-WINDOWS-2000-KEY';
        }
        elsif (defined $u->{'UserData'}->{'ProductKey'}) {
            # It is OK for us to return undef as long as there is a
            # ProductKey.
            return undef;
        }
        die "No ProductKey nor ProductID!";
    };
</pre>

<p>This code sets ProductID for Windows 2000 and ProductKey for
Windows XP and Windows Server 2003.  (The later OSes do accept
ProductID for backwards compatibility, but ProductKey is now
canonical.)  The code dispatches on the name of the chosen operating
system, as returned by the name() method of the <a
href="http://cvs.sourceforge.net/viewcvs.py/unattended/unattended/install/lib/Unattend/WinMedia.pm?rev=HEAD&amp;view=auto"
>Unattend::WinMedia</a> object.

<h2>More...</h2>

<p>More examples to come, someday.

<hr>
<address>
Patrick J. LoPresti <a
href="mailto:patl@users.sourceforge.net">patl@users.sourceforge.net</a>
</address>

<A href="http://sourceforge.net/"> <IMG align="right"
src="http://sourceforge.net/sflogo.php?group_id=62053&amp;type=5"
width="210" height="62" border="0" alt="SourceForge Logo"></A>

</body>
</html>
